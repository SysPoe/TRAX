export let SRT_DATA = [
    { from: "Roma Street", to: "Normanby", travelTrain: 2 },
    { from: "Brisbane - Roma Street", to: "Normanby", travelTrain: 2 },
    { from: "Normanby", to: "Exhibition", travelTrain: 1 },
    { from: "Exhibition", to: "Campbell Street", travelTrain: 1 },
    { from: "Campbell Street", to: "Mayne Junction", travelTrain: 1 },
    { from: "Mayne Junction", to: "Mayne", travelTrain: 1 },
    { from: "Bowen Hills", to: "Campbell Street", travelTrain: 1 },
    { from: "Bowen Hills", to: "Mayne", travelTrain: 1 },
    { from: "Mayne", to: "Albion", travelTrain: 2 },
    { from: "Albion", to: "Wooloowin", travelTrain: 1 },
    { from: "Wooloowin", to: "Eagle Junction", travelTrain: 1 },
    { from: "Eagle Junction", to: "Airport Junction", travelTrain: 1 },
    { from: "Airport Junction", to: "Toombul", travelTrain: 1 },
    { from: "Toombul", to: "Nundah", travelTrain: 1 },
    { from: "Nundah", to: "Northgate", travelTrain: 1 },
    { from: "Northgate", to: "Virginia", travelTrain: 2 },
    { from: "Virginia", to: "Sunshine", travelTrain: 1 },
    { from: "Sunshine", to: "Geebung", travelTrain: 1 },
    { from: "Geebung", to: "Zillmere", travelTrain: 2 },
    { from: "Zillmere", to: "Carseldine", travelTrain: 2 },
    { from: "Carseldine", to: "Bald Hills", travelTrain: 3 },
    { from: "Bald Hills", to: "Strathpine", travelTrain: 2 },
    { from: "Strathpine", to: "Bray Park", travelTrain: 1 },
    { from: "Bray Park", to: "Lawnton", travelTrain: 2 },
    { from: "Lawnton", to: "Petrie", travelTrain: 2 },
    { from: "Petrie", to: "Dakabin", travelTrain: 4 },
    { from: "Dakabin", to: "Narangba", travelTrain: 4 },
    { from: "Narangba", to: "Burpengary", travelTrain: 4 },
    { from: "Burpengary", to: "Morayfield", travelTrain: 5 },
    { from: "Morayfield", to: "Caboolture", travelTrain: 4 },
    { from: "Caboolture", to: "Elimbah", travelTrain: 7 },
    { from: "Elimbah", to: "Beerburrum", travelTrain: 5 },
    { from: "Beerburrum", to: "Glasshouse Mountains", travelTrain: 8 },
    { from: "Glasshouse Mountains", to: "Beerwah", travelTrain: 5 },
    { from: "Beerwah", to: "Landsborough", travelTrain: 5 },
    { from: "Landsborough", to: "Mooloolah", travelTrain: 6 },
    { from: "Mooloolah", to: "Eudlo", travelTrain: 7 },
    { from: "Eudlo", to: "Palmwoods", travelTrain: 4 },
    { from: "Palmwoods", to: "Woombye", travelTrain: 4 },
    { from: "Woombye", to: "Nambour", travelTrain: 2 },
    { from: "Northgate", to: "Bindha", travelTrain: 1 },
    { from: "Bindha", to: "Banyo", travelTrain: 1 },
    { from: "Banyo", to: "Nudgee", travelTrain: 1 },
    { from: "Nudgee", to: "Boondall", travelTrain: 2 },
    { from: "Boondall", to: "North Boondall", travelTrain: 1 },
    { from: "North Boondall", to: "Deagon", travelTrain: 1 },
    { from: "Deagon", to: "Sandgate", travelTrain: 1 },
    { from: "Sandgate", to: "Shorncliffe", travelTrain: 2 },
    { from: "Airport Junction", to: "International Terminal", travelTrain: 3 },
    { from: "International Terminal", to: "Domestic Terminal", travelTrain: 3 },
    { from: "Eagle Junction", to: "Clayfield", travelTrain: 1 },
    { from: "Clayfield", to: "Hendra", travelTrain: 1 },
    { from: "Hendra", to: "Ascot", travelTrain: 1 },
    { from: "Ascot", to: "Doomben", travelTrain: 2 },
    { from: "Eagle Farm", to: "Bunour", travelTrain: 1 },
    { from: "Bunour", to: "Meeandah", travelTrain: 1 },
    { from: "Meeandah", to: "Pinkenba", travelTrain: 2 },
    { from: "Bowen Hills", to: "Electric Depot Junction", travelTrain: 2 },
    { from: "Electric Depot Junction", to: "Windsor", travelTrain: 1 },
    { from: "Windsor", to: "Wilston", travelTrain: 1 },
    { from: "Wilston", to: "Newmarket", travelTrain: 1 },
    { from: "Newmarket", to: "Alderley", travelTrain: 1 },
    { from: "Alderley", to: "Enoggera", travelTrain: 1 },
    { from: "Enoggera", to: "Gaythorne", travelTrain: 1 },
    { from: "Gaythorne", to: "Mitchelton", travelTrain: 1 },
    { from: "Mitchelton", to: "Oxford Park", travelTrain: 1 },
    { from: "Oxford Park", to: "Grovely", travelTrain: 1 },
    { from: "Grovely", to: "Keperra", travelTrain: 1 },
    { from: "Keperra", to: "Ferny Grove", travelTrain: 3 },
    { from: "Roma Street", to: "Milton", travelTrain: 1 },
    { from: "Brisbane - Roma Street", to: "Milton", travelTrain: 1 },
    { from: "Milton", to: "Auchenflower", travelTrain: 1 },
    { from: "Auchenflower", to: "Toowong", travelTrain: 1 },
    { from: "Toowong", to: "Taringa", travelTrain: 1 },
    { from: "Taringa", to: "Indooroopilly", travelTrain: 1 },
    { from: "Indooroopilly", to: "Chelmer", travelTrain: 2 },
    { from: "Chelmer", to: "Graceville", travelTrain: 1 },
    { from: "Graceville", to: "Sherwood", travelTrain: 1 },
    { from: "Sherwood", to: "Corinda", travelTrain: 1 },
    { from: "Corinda", to: "Oxley", travelTrain: 2 },
    { from: "Oxley", to: "Darra", travelTrain: 2 },
    { from: "Darra", to: "Wacol", travelTrain: 2 },
    { from: "Wacol", to: "Gailes", travelTrain: 2 },
    { from: "Gailes", to: "Goodna", travelTrain: 1 },
    { from: "Goodna", to: "Redbank", travelTrain: 4 },
    { from: "Redbank", to: "Riverview", travelTrain: 2 },
    { from: "Riverview", to: "Dinmore", travelTrain: 1 },
    { from: "Dinmore", to: "Ebbw Vale", travelTrain: 2 },
    { from: "Ebbw Vale", to: "Bundamba", travelTrain: 2 },
    { from: "Bundamba", to: "Booval", travelTrain: 1 },
    { from: "Booval", to: "East Ipswich", travelTrain: 1 },
    { from: "East Ipswich", to: "Ipswich", travelTrain: 2 },
    { from: "Ipswich", to: "Thomas Street", travelTrain: 2 },
    { from: "Thomas Street", to: "Wulkuraka", travelTrain: 2 },
    { from: "Wulkuraka", to: "Karrabin", travelTrain: 2 },
    { from: "Karrabin", to: "Walloon", travelTrain: 3 },
    { from: "Walloon", to: "Thagoona", travelTrain: 3 },
    { from: "Thagoona", to: "Yarrowlea", travelTrain: 3 },
    { from: "Yarrowlea", to: "Rosewood", travelTrain: 1 },
    { from: "Corinda", to: "Moolabin", travelTrain: 1 },
    { from: "Yeerongpilly", to: "Tennyson Yard", travelTrain: 2 },
    { from: "Clapham", to: "Yeerongpilly", travelTrain: 1 },
    { from: "Tennyson Yard", to: "Moolabin", travelTrain: 2 },
    { from: "Salisbury", to: "Acacia Ridge", travelTrain: 5 },
    { from: "Roma Street", to: "South Brisbane", travelTrain: 4 },
    { from: "Brisbane - Roma Street", to: "South Brisbane", travelTrain: 4 },
    { from: "South Brisbane", to: "South Bank", travelTrain: 1 },
    { from: "South Bank", to: "Park Road", travelTrain: 1 },
    { from: "Park Road", to: "Dutton Park", travelTrain: 2 },
    { from: "Dutton Park", to: "Fairfield", travelTrain: 1 },
    { from: "Fairfield", to: "Yeronga", travelTrain: 2 },
    { from: "Yeronga", to: "Yeerongpilly", travelTrain: 1 },
    { from: "Yeerongpilly", to: "Moorooka", travelTrain: 1 },
    { from: "Moorooka", to: "Rocklea", travelTrain: 2 },
    { from: "Rocklea", to: "Salisbury", travelTrain: 1 },
    { from: "Salisbury", to: "Coopers Plains", travelTrain: 2 },
    { from: "Coopers Plains", to: "Banoon", travelTrain: 1 },
    { from: "Banoon", to: "Sunnybank", travelTrain: 1 },
    { from: "Sunnybank", to: "Altandi", travelTrain: 1 },
    { from: "Altandi", to: "Runcorn", travelTrain: 1 },
    { from: "Runcorn", to: "Fruitgrove", travelTrain: 2 },
    { from: "Fruitgrove", to: "Kuraby", travelTrain: 1 },
    { from: "Kuraby", to: "Trinder Park", travelTrain: 3 },
    { from: "Trinder Park", to: "Woodridge", travelTrain: 1 },
    { from: "Woodridge", to: "Kingston", travelTrain: 2 },
    { from: "Kingston", to: "Loganlea", travelTrain: 1 },
    { from: "Loganlea", to: "Bethania", travelTrain: 2 },
    { from: "Bethania", to: "Eden's Landing", travelTrain: 1 },
    { from: "Eden's Landing", to: "Holmview", travelTrain: 1 },
    { from: "Holmview", to: "Beenleigh", travelTrain: 2 },
    { from: "Beenleigh", to: "Ormeau", travelTrain: 7 },
    { from: "Ormeau", to: "Coomera", travelTrain: 5 },
    { from: "Coomera", to: "Helensvale", travelTrain: 5 },
    { from: "Helensvale", to: "Nerang", travelTrain: 5 },
    { from: "Nerang", to: "Robina", travelTrain: 5 },
    { from: "Robina", to: "Varsity Lakes", travelTrain: 4 },
    { from: "Park Road", to: "Buranda", travelTrain: 2 },
    { from: "Buranda", to: "Coorparoo", travelTrain: 1 },
    { from: "Coorparoo", to: "Norman Park", travelTrain: 1 },
    { from: "Norman Park", to: "Morningside", travelTrain: 2 },
    { from: "Morningside", to: "Cannon Hill", travelTrain: 1 },
    { from: "Cannon Hill", to: "Murarrie", travelTrain: 1 },
    { from: "Murarrie", to: "Hemmant", travelTrain: 2 },
    { from: "Hemmant", to: "Lindum", travelTrain: 2 },
    { from: "Lindum", to: "Lytton Junction", travelTrain: 1 },
    { from: "Lytton Junction", to: "Wynnum North", travelTrain: 1 },
    { from: "Wynnum North", to: "Wynnum", travelTrain: 2 },
    { from: "Wynnum", to: "Wynnum Central", travelTrain: 2 },
    { from: "Wynnum Central", to: "Manly", travelTrain: 2 },
    { from: "Manly", to: "Lota", travelTrain: 1 },
    { from: "Lota", to: "Thorneside", travelTrain: 1 },
    { from: "Thorneside", to: "Birkdale", travelTrain: 2 },
    { from: "Birkdale", to: "Wellington Point", travelTrain: 2 },
    { from: "Wellington Point", to: "Ormiston", travelTrain: 1 },
    { from: "Ormiston", to: "Cleveland", travelTrain: 2 },
    { from: "Lytton Junction", to: "Fisherman Islands", travelTrain: 10 },
    { from: "Nambour", to: "Yandina", travelTrain: 9 },
    { from: "Yandina", to: "North Arm", travelTrain: 6 },
    { from: "North Arm", to: "Eumundi", travelTrain: 4 },
    { from: "Eumundi", to: "Sunrise", travelTrain: 2 },
    { from: "Sunrise", to: "Cooroy", travelTrain: 6 },
    { from: "Cooroy", to: "Pomona", travelTrain: 9 },
    { from: "Pomona", to: "Cooran", travelTrain: 7 },
    { from: "Cooran", to: "Traveston", travelTrain: 6 },
    { from: "Traveston", to: "Woondum", travelTrain: 7 },
    { from: "Woondum", to: "Glanmire", travelTrain: 8 },
    { from: "Glanmire", to: "Gympie North", travelTrain: 4 },
    { from: "Yandina", to: "Eumundi", travelTrain: 10 },
    { from: "Eumundi", to: "Cooroy", travelTrain: 8 },
    { from: "Traveston", to: "Gympie North", travelTrain: 19 },
    { from: "Petrie", to: "Kallangur", travelTrain: 2 },
    { from: "Kallangur", to: "Murrumba Downs", travelTrain: 1 },
    { from: "Murrumba Downs", to: "Mango Hill", travelTrain: 2 },
    { from: "Mango Hill", to: "Mango Hill East", travelTrain: 2 },
    { from: "Mango Hill East", to: "Rothwell", travelTrain: 2 },
    { from: "Rothwell", to: "Kippa-Ring", travelTrain: 4 },
    { from: "Darra", to: "Richlands", travelTrain: 3 },
    { from: "Richlands", to: "Springfield", travelTrain: 5 },
    { from: "Springfield", to: "Springfield Central", travelTrain: 3 },
];
SRT_DATA = SRT_DATA.concat(SRT_DATA.map((v) => ({
    from: v.to,
    to: v.from,
    travelTrain: v.travelTrain,
})));
/**
 * Given an array of TrainMovementDTOs (stopping pattern), return an array of SRTStop including both stops and passing stops with SRT times.
 * For segments not in SRT_DATA, just include the stops as-is.
 */
export function expandWithSRTPassingStops(stoppingMovements) {
    function calcDelay(actual, planned) {
        if (!actual ||
            !planned ||
            actual === "0001-01-01T00:00:00" ||
            planned === "0001-01-01T00:00:00")
            return null;
        const a = new Date(actual).getTime();
        const p = new Date(planned).getTime();
        if (isNaN(a) || isNaN(p))
            return null;
        return Math.round((a - p) / 1000);
    }
    if (stoppingMovements.length < 2)
        return stoppingMovements.map((m) => ({
            placeName: m.PlaceName,
            isStop: true,
            plannedArrival: m.PlannedArrival,
            plannedDeparture: m.PlannedDeparture,
            actualArrival: m.ActualArrival,
            actualDeparture: m.ActualDeparture,
            arrivalDelaySeconds: calcDelay(m.ActualArrival, m.PlannedArrival),
            departureDelaySeconds: calcDelay(m.ActualDeparture, m.PlannedDeparture),
        }));
    const result = [];
    let prevTime = null;
    for (let i = 0; i < stoppingMovements.length - 1; ++i) {
        const from = stoppingMovements[i];
        const to = stoppingMovements[i + 1];
        // Always add the 'from' stop
        if (i === 0) {
            result.push({
                placeName: from.PlaceName,
                isStop: true,
                plannedArrival: from.PlannedArrival,
                plannedDeparture: from.PlannedDeparture,
                actualArrival: from.ActualArrival,
                actualDeparture: from.ActualDeparture,
                arrivalDelaySeconds: calcDelay(from.ActualArrival, from.PlannedArrival),
                departureDelaySeconds: calcDelay(from.ActualDeparture, from.PlannedDeparture),
            });
            // Set prevTime to actual/planned departure if available
            if (from.ActualDeparture &&
                from.ActualDeparture !== "0001-01-01T00:00:00") {
                prevTime = new Date(from.ActualDeparture);
            }
            else if (from.PlannedDeparture &&
                from.PlannedDeparture !== "0001-01-01T00:00:00") {
                prevTime = new Date(from.PlannedDeparture);
            }
            else {
                prevTime = null;
            }
        }
        // Find all SRT segments between from and to
        let seg = SRT_DATA.find((s) => (s.from === from.PlaceName && s.to === to.PlaceName) ||
            (s.from === to.PlaceName && s.to === from.PlaceName));
        if (seg) {
            // Direct SRT segment, no passing stops
            // Estimate next stop's arrival time
            let estPass = prevTime && seg.travelTrain
                ? new Date(prevTime.getTime() + seg.travelTrain * 60000)
                : undefined;
            result.push({
                placeName: to.PlaceName,
                isStop: true,
                plannedArrival: to.PlannedArrival,
                plannedDeparture: to.PlannedDeparture,
                actualArrival: to.ActualArrival,
                actualDeparture: to.ActualDeparture,
                srtMinutes: seg.travelTrain,
                estimatedPassingTime: estPass
                    ? estPass.getFullYear().toString().padStart(4, "0") +
                        "-" +
                        (estPass.getMonth() + 1).toString().padStart(2, "0") +
                        "-" +
                        estPass.getDate().toString().padStart(2, "0") +
                        "T" +
                        estPass.getHours().toString().padStart(2, "0") +
                        ":" +
                        estPass.getMinutes().toString().padStart(2, "0") +
                        ":" +
                        estPass.getSeconds().toString().padStart(2, "0")
                    : undefined,
                arrivalDelaySeconds: calcDelay(to.ActualArrival, to.PlannedArrival),
                departureDelaySeconds: calcDelay(to.ActualDeparture, to.PlannedDeparture),
            });
            prevTime = estPass ?? null;
            continue;
        }
        // Try to find a chain of SRT segments between from and to (i.e. passing stops)
        // BFS to find shortest SRT path
        let queue = SRT_DATA.filter((s) => s.from.trim().toLocaleLowerCase() ===
            from.PlaceName.trim().toLowerCase()).map((s) => ({ path: [s], last: s.to }));
        queue =
            queue.length == 0
                ? SRT_DATA.filter((s) => s.to.trim().toLocaleLowerCase() ===
                    from.PlaceName.trim().toLowerCase()).map((s) => ({ path: [s], last: s.from }))
                : queue;
        let found = null;
        let visited = new Set();
        while (queue.length && !found) {
            let { path, last } = queue.shift();
            if (last === to.PlaceName) {
                found = path;
                break;
            }
            if (visited.has(last))
                continue;
            visited.add(last);
            for (let next of SRT_DATA.filter((s) => s.from.trim().toLowerCase() === last.trim().toLowerCase() ||
                s.to.trim().toLowerCase() === last.trim().toLowerCase())) {
                if (!visited.has(next.to))
                    queue.push({ path: [...path, next], last: next.to });
            }
        }
        if (found) {
            // Only add true passing stops (all except the last segment)
            for (let j = 1; j < found.length - 1; ++j) {
                const foundSeg = found[j];
                if (foundSeg) {
                    const orig = stoppingMovements.find((m) => m.PlaceName === foundSeg.from);
                    let estPass = prevTime && foundSeg.travelTrain
                        ? new Date(prevTime.getTime() + foundSeg.travelTrain * 60000)
                        : undefined;
                    result.push({
                        placeName: foundSeg.from,
                        isStop: false,
                        plannedArrival: orig?.PlannedArrival || "",
                        plannedDeparture: orig?.PlannedDeparture || "",
                        actualArrival: orig?.ActualArrival,
                        actualDeparture: orig?.ActualDeparture,
                        srtMinutes: foundSeg.travelTrain,
                        estimatedPassingTime: estPass
                            ? estPass.getFullYear().toString().padStart(4, "0") +
                                "-" +
                                (estPass.getMonth() + 1).toString().padStart(2, "0") +
                                "-" +
                                estPass.getDate().toString().padStart(2, "0") +
                                "T" +
                                estPass.getHours().toString().padStart(2, "0") +
                                ":" +
                                estPass.getMinutes().toString().padStart(2, "0") +
                                ":" +
                                estPass.getSeconds().toString().padStart(2, "0")
                            : undefined,
                        arrivalDelaySeconds: calcDelay(orig?.ActualArrival ||
                            (estPass ? estPass.toISOString() : undefined), orig?.PlannedArrival ||
                            (estPass ? estPass.toISOString() : undefined)),
                        departureDelaySeconds: calcDelay(orig?.ActualDeparture ||
                            (estPass ? estPass.toISOString() : undefined), orig?.PlannedDeparture ||
                            (estPass ? estPass.toISOString() : undefined)),
                    });
                    prevTime = estPass ?? null;
                }
            }
            // Add the final stop (not as a passing stop)
            let lastSeg = found[found.length - 1];
            let estArr = prevTime && lastSeg && lastSeg.travelTrain
                ? new Date(prevTime.getTime() + lastSeg.travelTrain * 60000)
                : undefined;
            result.push({
                placeName: to.PlaceName,
                isStop: true,
                plannedArrival: to.PlannedArrival,
                plannedDeparture: to.PlannedDeparture,
                actualArrival: to.ActualArrival,
                actualDeparture: to.ActualDeparture,
                srtMinutes: lastSeg?.travelTrain,
                estimatedPassingTime: estArr
                    ? estArr.getFullYear().toString().padStart(4, "0") +
                        "-" +
                        (estArr.getMonth() + 1).toString().padStart(2, "0") +
                        "-" +
                        estArr.getDate().toString().padStart(2, "0") +
                        "T" +
                        estArr.getHours().toString().padStart(2, "0") +
                        ":" +
                        estArr.getMinutes().toString().padStart(2, "0") +
                        ":" +
                        estArr.getSeconds().toString().padStart(2, "0")
                    : undefined,
                arrivalDelaySeconds: calcDelay(to.ActualArrival, to.PlannedArrival),
                departureDelaySeconds: calcDelay(to.ActualDeparture, to.PlannedDeparture),
            });
            prevTime = estArr ?? null;
            continue;
        }
        // else: no SRT path found, include the stop
        result.push({
            placeName: to.PlaceName,
            isStop: true,
            plannedArrival: to.PlannedArrival,
            plannedDeparture: to.PlannedDeparture,
            actualArrival: to.ActualArrival,
            actualDeparture: to.ActualDeparture,
            arrivalDelaySeconds: calcDelay(to.ActualArrival, to.PlannedArrival),
            departureDelaySeconds: calcDelay(to.ActualDeparture, to.PlannedDeparture),
        });
        // Update prevTime for next segments
        if (to.ActualDeparture && to.ActualDeparture !== "0001-01-01T00:00:00") {
            prevTime = new Date(to.ActualDeparture);
        }
        else if (to.PlannedDeparture && to.PlannedDeparture !== "0001-01-01T00:00:00") {
            prevTime = new Date(to.PlannedDeparture);
        }
    }
    // End for loop
    return result;
}
